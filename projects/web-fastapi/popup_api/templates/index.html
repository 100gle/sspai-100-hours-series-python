<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Todolist</title>
  <link rel="stylesheet" href="../static/css/simple-v1.min.css" />
  <link rel="stylesheet" href="../static/css/style.css" />
</head>

<body>
  <div class="container">
    <nav class="navbar">
      <ul>
        <li><a href="https://sspai.com" class="logo"><img src="../static/sspai-logo-light.svg" alt="logo"></a>
        </li>
        <li><a href="#">Home</a></li>
        <li><a href="#">Task</a></li>
        <li><a href="#">About</a></li>
      </ul>
    </nav>
    <hr />
    <div class="data-table">
      <p v-if="tasks.length === 0">
        ğŸ¤” Whoopsâ€¦â€¦ä¼¼ä¹ä»»åŠ¡éƒ½åšå®Œäº†ï¼Ÿé‚£ä¹ˆå¯ä»¥ç‚¹å‡»ä¸‹æ–¹çš„æŒ‰é’®æ·»åŠ ä»»åŠ¡ï¼
      </p>
      <table v-else>
        <!-- Fields -->
        <thead>
          <tr>
            <th v-for="field, index in fields" :key="index" scope="col">
              [[ mappingFields(field) ]]
            </th>
          </tr>
        </thead>
        <!-- Data -->
        <tbody>
          <tr v-for="task in tasks">
            <td>[[ task.id ]]</td>
            <td>[[ task.name ]]</td>
            <td>[[ mappingPriority(task.priority) ]]</td>
            <td>[[ task.description ]]</td>
            <td>[[ isDone(task.is_done) ]]</td>
            <td>[[ mappingGroups(task.group_id) ]]</td>
            <td>
              <div class="ops">
                <span @click="updateTask(task.id)">æ›´æ–°</span>
                <span @click="deleteTask(task.id)">åˆ é™¤</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="btn-add-task" @click="showForm">
      <button>+</button>
    </div>
    <div class="task-form">
      <form v-bind:action="apis.createTask" method="post" class="form">
        <div>
          <label for="taskName">ä»»åŠ¡åç§°ï¼š</label>
          <input type="text" name="taskName" id="taskName" placeholder="è¯·è¾“å…¥å¾…åŠäº‹é¡¹åç§°" />
        </div>
        <div>
          <label for="taskPriority">ä¼˜å…ˆçº§ï¼š</label>
          <select name="taskPriority" id="taskPriority">
            <option value="1" selected>ä¸€èˆ¬</option>
            <option value="2">ä¼˜å…ˆ</option>
            <option value="3">ç´§æ€¥</option>
          </select>
        </div>
        <div>
          <label for="taskGroup"> åˆ†ç»„ï¼š </label>
          <select name="taskGroup" id="taskGroup">
            <option :value="index" v-for="([index, group]) in Object.entries(groups)">
              [[ group ]]
            </option>
          </select>
        </div>
        <div>
          <label for="taskDescription">ä»»åŠ¡å¤‡æ³¨ï¼š</label>
          <textarea name="taskDescription" id="taskDescription" rows="5" placeholder="å¤‡æ³¨å†…å®¹ï¼ˆå¯é€‰ï¼‰"></textarea>
        </div>
        <div class="btn-submit">
          <input ref="submit" type="submit" value="æ·»åŠ " />
        </div>
      </form>
    </div>
    <footer id="footer">
      <p class="copyright">&copy; 100gle & sspai</p>
    </footer>
  </div>
</body>
<script src="../static/js/vue.min.js"></script>
<script src="../static/js/axios.min.js"></script>
<script>
  const address = "http://localhost:8000";
  const app = new Vue({
    el: ".container",
    delimiters: ["[[", "]]"],
    data() {
      return {
        tasks: [],
        fields: [],
        apis: {
          getAllTasks: `${address}/api/tasks`,
          createTask: `${address}/api/tasks/create`,
          updateTask: `${address}/api/tasks/update`,
          deleteTask: `${address}/api/tasks/delete`,
          getGroups: `${address}/api/groups`
        },
        groups: [],
      }
    },
    methods: {
      showForm(e) {
        const formDiv = document.querySelector(".task-form");
        if (formDiv.style.display === "") {
          formDiv.style.display = "none";
        }
        formDiv.style.display = formDiv.style.display === "none" ? "flex" : "none";
      },
      getAllTasks() {
        axios.get(this.apis.getAllTasks)
          .then(res => {
            let json = res.data.data
            this.tasks = json

            let fields = Object.keys(json[0])
            fields.push("operators")

            this.fields = fields
          })
          .catch(err => console.error)
      },
      updateTask(task_id) {
        axios.put(`${this.apis.updateTask}/${task_id}`).then(res => {
          this.getAllTasks();
        })
      },
      deleteTask(task_id) {
        axios.delete(`${this.apis.deleteTask}/${task_id}`).then(res => {
          this.getAllTasks();
        })
      },
      mappingFields(field) {
        let mapping = {
          id: "åºå·",
          name: "ä»»åŠ¡åç§°",
          priority: "ä¼˜å…ˆçº§",
          description: "ä»»åŠ¡æè¿°",
          is_done: "æ˜¯å¦å®Œæˆ",
          group_id: "åˆ†ç»„",
          operators: "æ“ä½œ",
        }
        return mapping[field];
      },
      isDone(done) {
        return done === 1 ? "å®Œæˆ" : "æœªå®Œæˆ"
      },
      mappingPriority(value) {
        let mapping = {
          0: "ä¸€èˆ¬",
          1: "ä¼˜å…ˆ",
          3: "ç´§æ€¥"
        }
        return mapping[value]
      },
      mappingGroups(value) {
        return this.groups[value]
      },
      getGroups() {
        axios.get(this.apis.getGroups)
          .then(res => {
            let data = res.data.data
            let mappings = {}
            data.reduce((id, group) => {
              Object.assign(mappings, {
                [group.id]: group.name
              })
            }, {})

            this.groups = mappings
          })
          .catch(err => console.error)
      },
    },
    mounted: function (e) {
      this.getAllTasks();
      this.getGroups();
    }
  })
</script>

</html>